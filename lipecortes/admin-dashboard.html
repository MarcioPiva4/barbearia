<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard do Administrador</title>
  <link rel="stylesheet" href="admin-dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="layout">

    <!-- Header com logout -->
    <header class="header">
      <h1 class="page-title">Dashboard do Administrador</h1>
      <button id="logout-btn" class="btn red">Sair</button>
    </header>

    <!-- Gráficos (mock) -->
    <section class="charts">
      <div class="chart-card">[Gráfico de Agendamentos]</div>
      <div class="chart-card">[Gráfico de Serviços]</div>
    </section>

    <!-- Agendamentos -->
    <section class="section">
      <h2>Agendamentos</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Serviços</th>
              <th>Status</th>
              <th>Ações</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="agendamentos-table-body">
            <tr><td colspan="5">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Serviços -->
    <section class="section">
      <h2>Gerenciamento de Serviços</h2>

      <!-- Novo Serviço -->
      <div class="new-service">
        <input type="text" placeholder="Nome do serviço" id="novo-servico-nome">
        <input type="text" placeholder="Descrição" id="novo-servico-desc">
        <input type="number" placeholder="Preço" id="novo-servico-preco">
        <button class="btn orange">Adicionar Serviço</button>
      </div>

      <!-- Lista de Serviços -->
      <div class="services-list" id="services-list">
        <!-- Será populada futuramente -->
      </div>
    </section>

  </div>

  <script>
    // === FUNÇÃO LOGOUT ===
    document.getElementById("logout-btn").addEventListener("click", async () => {
      try {
        const res = await fetch("https://lipes-cortes.vercel.app/api/logout", { method: "POST" });
        const data = await res.json();
        alert(data.message || "Logout realizado");
        window.location.href = "auth.html"; // volta para login
      } catch (err) {
        console.error("Erro no logout", err);
      }
    });

    // === FUNÇÃO PARA LISTAR AGENDAMENTOS ===
    async function carregarAgendamentos() {
      const tbody = document.getElementById("agendamentos-table-body");
      tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

      try {
        const res = await fetch("https://lipes-cortes.vercel.app/api/agendamentos");
        const agendamentos = await res.json();

        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="5">${agendamentos.error || "Erro ao carregar"}</td></tr>`;
          return;
        }

        if (agendamentos.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5">Nenhum agendamento encontrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = "";
        agendamentos.forEach((ag) => {
          const tr = document.createElement("tr");

          const cliente = ag.user?.nome || "N/A";
          const servicos = ag.servicos.map(s => s.servico.nome).join(", ");
          const status = ag.status;
          const data = new Date(ag.dataAgendamento).toLocaleString("pt-BR");

          tr.innerHTML = `
            <td>${cliente}</td>
            <td>${servicos}</td>
            <td><span class="badge ${status === "CONFIRMADO" ? "badge-confirmado" : "badge-pendente"}">${status}</span></td>
            <td>
              ${status === "PENDENTE" ? `<button class="btn-link orange" onclick="confirmarAgendamento('${ag.id}')">Confirmar</button>` : ""}
              <button class="btn-link purple" onclick="alterarDataAgendamento('${ag.id}')">Alterar Data</button>
            </td>
            <td>${data}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Erro ao carregar agendamentos:", err);
        tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar dados</td></tr>`;
      }
    }

    // === CONFIRMAR AGENDAMENTO ===
    async function confirmarAgendamento(id) {
      try {
        const res = await fetch(`https://lipes-cortes.vercel.app/api/agendamentos/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "CONFIRMADO" }),
        });
        if (res.ok) {
          alert("Agendamento confirmado!");
          carregarAgendamentos();
        } else {
          const data = await res.json();
          alert(data.error || "Erro ao confirmar");
        }
      } catch (err) {
        console.error("Erro ao confirmar agendamento:", err);
      }
    }

    // === ALTERAR DATA ===
    async function alterarDataAgendamento(id) {
      const novaData = prompt("Digite a nova data e hora (ex: 2025-09-20 14:00)");
      if (!novaData) return;

      try {
        const res = await fetch(`https://lipes-cortes.vercel.app/api/agendamentos/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ novaData }),
        });
        if (res.ok) {
          alert("Data alterada!");
          carregarAgendamentos();
        } else {
          const data = await res.json();
          alert(data.error || "Erro ao alterar data");
        }
      } catch (err) {
        console.error("Erro ao alterar data:", err);
      }
    }

    // Inicializa a página
    carregarAgendamentos();
  </script>
</body>
</html>
